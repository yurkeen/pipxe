piPXE - iPXE for the Raspberry Pi
=================================

[![Build Status](https://github.com/yurkeen/pipxe/workflows/build/badge.svg)](https://github.com/yurkeen/pipxe/actions?query=workflow:build)

piPXE is a build of the [iPXE] network boot firmware for the
[Raspberry Pi].

Quick start
-----------

1. Download [sdcard.img] and write it onto any blank micro SD card
using a tool such as `dd` or [Etcher].

2. Insert the micro SD card into your Raspberry Pi.

3. Power on your Raspberry Pi.

Within a few seconds you should see iPXE appear and begin booting from
the network:

![Screenshot](screenshot.png)

Building from source
--------------------

To build from source, clone this repository and run `make`.  This will
build all of the required components and eventually generate the SD
card image [sdcard.img].

You will need various build tools installed, including a
cross-compiling version of `gcc` for building AArch64 binaries.  See
the [Dockerfile](Dockerfile) for hints on which packages to install.

To build using the provided Dockerfile, use the following flow
```sh

# Build the Docker image first
docker build -t pipxe-builder .
# Build the pipxe image
docker run --rm -it -v $(pwd):/opt/build pipxe-builder
```
As a result of a successfully completed build, the `sdcard.img` file should
appear in the repository directory.

How it works
------------

The SD card image contains:

* Broadcom [VC4 boot firmware]: `bootcode.bin` and related files
* [TianoCore EDK2] UEFI firmware built for the [RPi4] platform: `RPI_EFI.fd`
* [iPXE] built for the `arm64-efi` platform: `/efi/boot/bootaa64.efi`

The Raspberry Pi has a somewhat convoluted boot process in which the
VC4 GPU is responsible for loading the initial executable ARM CPU
code.  The flow of execution is approximately:

1. The GPU code in the onboard boot ROM loads `bootcode.bin` from the SD card.
2. The GPU executes `bootcode.bin` and loads `RPI_EFI.fd` from the SD card.
3. The GPU allows the CPU to start executing `RPI_EFI.fd`.
4. The CPU executes `RPI_EFI.fd` and loads `bootaa64.efi` from the SD card.
5. The CPU executes `bootaa64.efi` (i.e. iPXE) to boot from the network.

Licence
-------

Every component is under an open source licence.  See the individual
subproject licensing terms for more details:

* <https://github.com/raspberrypi/firmware/blob/master/boot/LICENCE.broadcom>
* <https://github.com/tianocore/edk2/blob/master/Readme.md>
* <https://ipxe.org/licensing>

[iPXE]: https://ipxe.org
[Raspberry Pi]: https://www.raspberrypi.org
[sdcard.img]: https://github.com/ipxe/pipxe/releases/latest/download/sdcard.img
[Etcher]: https://www.balena.io/etcher
[VC4 boot firmware]: https://github.com/raspberrypi/firmware/tree/master/boot
[TianoCore EDK2]: https://github.com/tianocore/edk2
[RPi4]: https://github.com/tianocore/edk2-platforms/tree/master/Platform/RaspberryPi/RPi4
